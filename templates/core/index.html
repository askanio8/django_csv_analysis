{% extends 'core/base.html' %}
{% load static %}
{% block graphs %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <form action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="myFile"
                   class="custom-file-label btn btn-sm btn-outline-secondary"
                   style="background-color: #c9ddc4">
                Upload file
                <input type="file"
                       id="myFile"
                       name="filename"
                       class="custom-file-input"
                       onchange="this.form.submit();" />
            </label>
        </form>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button"
                        id="prevButton"
                        class="btn btn-sm btn-outline-secondary"
                        style="background-color: #c9ddc4">Previous</button>
                <button type="button"
                        id="nextButton"
                        class="btn btn-sm btn-outline-secondary"
                        style="background-color: #c9ddc4">Next</button>
            </div>
        <button type="button" id="create-report-btn" class="btn btn-sm btn-outline-secondary" style="background-color: #c9ddc4">Create report</button>

        <script>
            document.getElementById('create-report-btn').addEventListener('click', function() {
                var button = this;
                if (button.dataset.status === 'open') {
                    window.open(button.dataset.reportUrl, '_blank');
                    return;
                }
                button.innerText = 'Wait...';
                fetch('{% url "generate_ydata_html" %}')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert('Error creating report: ' + data.error);
                            button.innerText = 'Create report';
                        } else {
                            button.dataset.reportUrl = data.report_url;
                            button.dataset.status = 'open';
                            button.innerText = 'Open report';
                        }
                    })
                    .catch(error => {
                        console.error('There was a problem with your fetch operation:', error);
                        button.innerText = 'Create report';
                    });
            });
        </script>
        </div>
    </div>
    <script>
  document.addEventListener("DOMContentLoaded", function() {
      let currentIndex = 0;
      const graphs = {{ graphs_list|safe }};
      const imgElement = document.getElementById("graphImage");

      function updateImage() {
          imgElement.src = graphs[currentIndex];
      }

      document.getElementById("prevButton").addEventListener("click", function() {
          if (currentIndex > 0) {
              currentIndex--;
              updateImage();
          }
      });

      document.getElementById("nextButton").addEventListener("click", function() {
          if (currentIndex < graphs.length - 1) {
              currentIndex++;
              updateImage();
          }
      });

      // Инициализация первого изображения
      updateImage();
  });
    </script>
    {% if graphs_list %}
        <div style="text-align: center; margin-top: 10px">
            <img id="graphImage"
                 src=""
                 alt="Graph"
                 class="img-fluid"
                 style="display: block;
                        margin-left: auto;
                        margin-right: auto" />
        </div>
    {% else %}
        <div style="text-align: center; margin-top: 10px">
            <p>No graphs available.</p>
        </div>
    {% endif %}
{% endblock %}
{% block table %}
    <div class="table-responsive small">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    {% for col in columns %}<th scope="col">{{ col|slice:":12" }}</th>{% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in table %}
                    <tr>
                        {% for r in row %}<td>{{ r|slice:":12" }}</td>{% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock table %}
